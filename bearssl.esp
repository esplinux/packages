name    = "bearssl"
version = "HEAD" 
rev     = "0"

source = fetch(git="https://www.bearssl.org/git/BearSSL")

load("musl.esp", "MUSL")

out = source + "-out"
cflags = "-fPIC -Qunused-arguments --sysroot=%s -O3" % MUSL.sysroot
ldflags = "-rtlib=compiler-rt --sysroot=%s" % MUSL.sysroot

shell("printf 'include conf/Unix.mk\n' > %s/conf/esp.mk" % source)
shell("printf 'BUILD=%s\n' >> %s/conf/esp.mk" % (out, source))
shell("printf 'CC=clang\n' >> %s/conf/esp.mk" % source)
shell("printf 'CFLAGS=%s\n' >> %s/conf/esp.mk" % (cflags, source))
shell("printf 'LD=clang\n' >> %s/conf/esp.mk" % source)
shell("printf 'LDFLAGS=%s\n' >> %s/conf/esp.mk" % (ldflags, source))
shell("printf 'LDDLL=clang\n' >> %s/conf/esp.mk" % source)
make(source, "-j %s CONF=esp" % NPROC)

shell("cd %s; mkdir bin" % out)
shell("cd %s; mkdir lib" % out)
shell("cd %s; mkdir include" % out)
shell("cd %s/include; cp %s/inc/* ." % (out, source))
shell("cd %s; mv *.so lib" % out)
shell("cd %s; mv *.a lib" % out)
shell("cd %s; rm -rf obj" % out)
shell("cd %s; mv brssl bin" % out)
shell("cd %s; mv test* bin" % out)

BEARSSL = struct(
  name    = name, 
  version = version, 
  rev     = rev,
  package = tarball(out, name, version, rev),
  lib = out + "/lib",
  include = out + "/include"
)
